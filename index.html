<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Dashboard de Pedidos — 8 días, navegación semanal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f5f7fa;
      --card:#ffffff;
      --accent:#007bff;
      --green-bg:#e9f7ee;
      --green-border:#28a745;
      --muted:#666;
    }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); margin:0; padding:1rem; color:#222; }
    header { display:flex; flex-direction:column; gap:.5rem; align-items:center; margin-bottom:1rem; }
    h1 { margin:0; font-size:1.25rem; text-align:center; }
    .sub { color:var(--muted); font-size:.95rem; }

    .nav { display:flex; gap:.5rem; justify-content:center; margin:1rem 0; }
    .nav button {
      padding:.6rem 1rem; border:none; border-radius:8px; cursor:pointer;
      background:var(--accent); color:#fff; font-weight:600;
      box-shadow:0 4px 10px rgba(0,0,0,.08);
    }
    .nav button.secondary { background:#6c757d; }

    /* Contenedor de tarjetas: grid responsive */
    #contenedor-dias {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap:1.25rem;
      align-items:start;
      padding:0 0.5rem;
    }

    /* Tarjetas grandes */
    .tarjeta-dia {
      background:var(--card);
      padding:1.6rem;
      border-radius:14px;
      box-shadow:0 8px 24px rgba(16,24,40,.06);
      cursor:pointer;
      min-height:220px;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      transition:transform .14s ease, box-shadow .14s ease, border-color .14s ease, background .14s ease;
      border:3px solid transparent;
    }
    .tarjeta-dia:hover { transform:translateY(-6px); box-shadow:0 14px 40px rgba(16,24,40,.12); }
    .tarjeta-dia.verde { background:var(--green-bg); border-color:var(--green-border); }

    .tarjeta-dia h3 { margin:0 0 .6rem; font-size:1.25rem; text-transform:capitalize; color:#111; }
    .tarjeta-info { color:var(--muted); font-size:1rem; margin-top:auto; }

    /* Modales */
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1200; align-items:center; justify-content:center; padding:1rem; }
    .modal.show { display:flex; }
    .modal-content {
      background:var(--card); width:96%; max-width:920px; border-radius:12px; padding:1rem 1.25rem;
      box-shadow:0 18px 50px rgba(2,6,23,.28); max-height:86vh; overflow:auto;
    }
    .modal-content.green { background:var(--green-bg); }
    .modal-header { display:flex; justify-content:space-between; align-items:center; gap:1rem; }
    .modal-header h2 { margin:0; font-size:1.05rem; }
    .close { cursor:pointer; font-size:1.4rem; padding:.25rem .5rem; border-radius:8px; border:none; background:transparent; }

    .modal-body { margin-top:.75rem; }

    .cafeteria-card {
      display:flex; justify-content:space-between; align-items:center; gap:.5rem;
      padding:.75rem 1rem; border-radius:10px; border:1px solid #e0e0e0; margin:.5rem 0; background:#fff; cursor:pointer;
    }
    .cafeteria-card:hover { background:#fafafa; }

    .pedido { padding:.5rem 0; border-bottom:1px solid #eee; }
    .pedido:last-child { border-bottom:none; }
    .muted { color:var(--muted); font-size:.95rem; }
    .small { font-size:.9rem; color:#444; }

    /* Responsive tweaks */
    @media (max-width:520px){
      .tarjeta-dia { padding:1rem; min-height:160px; }
      #contenedor-dias { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Pedidos — vista semanal ampliada (8 tarjetas grandes, sin domingos)</h1>
    <div class="sub">Navega por semanas completas; cada tarjeta muestra un día (base + 7 siguientes) y se ocultan domingos</div>
  </header>

  <div class="nav" role="navigation" aria-label="Navegación de semanas">
    <button id="prev">← Semana anterior</button>
    <button id="today" class="secondary">Hoy</button>
    <button id="next">Semana siguiente →</button>
  </div>

  <main>
    <div id="contenedor-dias" aria-live="polite"></div>
  </main>

  <!-- Modal: cafeterías del día -->
  <div id="modal-cafeterias" class="modal" role="dialog" aria-modal="true">
    <div id="modal-cafeterias-content" class="modal-content" role="document">
      <div class="modal-header">
        <h2 id="modal-cafeterias-title"></h2>
        <button id="close-cafeterias" class="close" aria-label="Cerrar">&times;</button>
      </div>
      <div id="modal-cafeterias-body" class="modal-body"></div>
    </div>
  </div>

  <!-- Modal: pedidos de una cafetería -->
  <div id="modal-pedidos" class="modal" role="dialog" aria-modal="true">
    <div id="modal-pedidos-content" class="modal-content" role="document">
      <div class="modal-header">
        <h2 id="modal-pedidos-title"></h2>
        <button id="close-pedidos" class="close" aria-label="Cerrar">&times;</button>
      </div>
      <div id="modal-pedidos-body" class="modal-body"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // --- Config Supabase (reemplaza si hace falta) ---
    const SUPABASE_URL = "https://pqphzdodpassomggthid.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxcGh6ZG9kcGFzc29tZ2d0aGlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1ODMxMTIsImV4cCI6MjA4MzE1OTExMn0.mQNeavAOItO-wTgfGVac-z91baYxsa6866HpBOZy3nM";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- Utilidades de fecha para columnas DATE (YYYY-MM-DD) ---
    function parseDateFromDateString(dateStr) {
      if (!dateStr) return null;
      const parts = String(dateStr).split("-");
      if (parts.length < 3) return new Date(dateStr);
      const y = Number(parts[0]), m = Number(parts[1]) - 1, d = Number(parts[2]);
      return new Date(y, m, d); // local midnight
    }
    function resetToLocalMidnight(d) {
      return new Date(d.getFullYear(), d.getMonth(), d.getDate());
    }
    function sameDay(a,b) {
      return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
    }
    function addDays(d,n) {
      const x = new Date(d);
      x.setDate(x.getDate() + n);
      return resetToLocalMidnight(x);
    }
    const opcionesTitulo = { weekday:'long', day:'numeric', month:'long' };
    function toTitleEsMX(d) { return d.toLocaleDateString('es-MX', opcionesTitulo); }

    // --- Estado ---
    let allPedidos = []; // cache de pedidos
    let baseDate = resetToLocalMidnight(new Date()); // inicio del bloque (por defecto hoy)

    // --- Cargar pedidos desde Supabase ---
    async function loadPedidos() {
      try {
        const { data, error } = await client
          .from("pedidos")
          .select("id,cafeterias_id,sucursal,producto,cantidad,fecha_pedido,fecha_registro,notas,cafeterias(nombre)")
          .order("fecha_pedido", { ascending: true });

        if (error) {
          console.error("Error cargando pedidos:", error);
          return;
        }
        allPedidos = Array.isArray(data) ? data : [];
      } catch (err) {
        console.error("Excepción al cargar pedidos:", err);
      }
    }

    // --- Construir 8 días a partir de baseDate, saltando domingos ---
    function buildEightDays(startDate) {
      const days = [];
      let cursor = resetToLocalMidnight(startDate);
      while (days.length < 8) {
        if (cursor.getDay() !== 0) days.push(new Date(cursor));
        cursor = addDays(cursor, 1);
      }
      return days;
    }

    // --- Renderizar tarjetas grandes (8) ---
    function renderEightCards() {
      const contenedor = document.getElementById("contenedor-dias");
      const days = buildEightDays(baseDate);
      contenedor.innerHTML = "";

      days.forEach(day => {
        const title = toTitleEsMX(day);
        const tarjeta = document.createElement("div");
        tarjeta.className = "tarjeta-dia";
        tarjeta.innerHTML = `<h3>${title}</h3><div class="tarjeta-info muted">Toca para ver cafeterías con pedidos</div>`;

        // Filtrar por fecha_pedido (columna DATE -> "YYYY-MM-DD")
        const pedidosDia = allPedidos.filter(p => {
          if (!p.fecha_pedido) return false;
          const fp = parseDateFromDateString(p.fecha_pedido);
          return sameDay(fp, day);
        });

        if (pedidosDia.length > 0) tarjeta.classList.add("verde");

        tarjeta.onclick = () => openCafeteriasModal(day, title, pedidosDia);
        contenedor.appendChild(tarjeta);
      });
    }

    // --- Modal cafeterías ---
    const modalCaf = document.getElementById("modal-cafeterias");
    const modalCafContent = document.getElementById("modal-cafeterias-content");
    const modalCafTitle = document.getElementById("modal-cafeterias-title");
    const modalCafBody = document.getElementById("modal-cafeterias-body");
    document.getElementById("close-cafeterias").onclick = () => modalCaf.classList.remove("show");

    function openCafeteriasModal(dayObj, dayTitle, pedidosDia) {
      modalCafTitle.textContent = `Cafeterías con pedidos para ${dayTitle}`;
      modalCafBody.innerHTML = "";

      if (!pedidosDia || pedidosDia.length === 0) {
        modalCafContent.classList.remove("green");
        modalCafBody.innerHTML = "<p class='muted'>No hay pedidos para este día.</p>";
      } else {
        modalCafContent.classList.add("green");
        // Agrupar por cafetería (usar cafeterias_id si existe)
        const byCafe = new Map();
        pedidosDia.forEach(p => {
          const key = (p.cafeterias_id !== null && p.cafeterias_id !== undefined) ? String(p.cafeterias_id) : (p.cafeterias?.nombre || "desconocida");
          if (!byCafe.has(key)) byCafe.set(key, { nombre: p.cafeterias?.nombre || "?", pedidos: [] });
          byCafe.get(key).pedidos.push(p);
        });

        byCafe.forEach(({ nombre, pedidos }) => {
          const total = pedidos.reduce((acc, x) => acc + (Number(x.cantidad) || 0), 0);
          const card = document.createElement("div");
          card.className = "cafeteria-card";
          card.innerHTML = `<div><strong>${nombre}</strong><div class="muted">${pedidos.length} fila(s) en tabla</div></div><div class="muted">Total piezas: ${total}</div>`;
          card.onclick = () => openPedidosModal(nombre, dayTitle, pedidos);
          modalCafBody.appendChild(card);
        });
      }
      modalCaf.classList.add("show");
    }

    // --- Modal pedidos por cafetería (agrupa productos por pedido id) ---
    const modalPed = document.getElementById("modal-pedidos");
    const modalPedContent = document.getElementById("modal-pedidos-content");
    const modalPedTitle = document.getElementById("modal-pedidos-title");
    const modalPedBody = document.getElementById("modal-pedidos-body");
    document.getElementById("close-pedidos").onclick = () => modalPed.classList.remove("show");

  function openPedidosModal(nombreCafe, dayTitle, pedidosCafe) {
  modalPedTitle.textContent = `Pedidos de ${nombreCafe} — ${dayTitle}`;
  modalPedBody.innerHTML = "";

  if (!pedidosCafe || pedidosCafe.length === 0) {
    modalPedContent.classList.remove("green");
    modalPedBody.innerHTML = "<p class='muted'>Sin pedidos.</p>";
  } else {
    modalPedContent.classList.add("green");

    // Agrupar por combinación fecha_pedido + cafetería + sucursal
    const grouped = {};
    pedidosCafe.forEach(p => {
      const key = `${p.fecha_pedido}_${p.cafeterias?.nombre}_${p.sucursal}`;
      if (!grouped[key]) {
        grouped[key] = { sucursal: p.sucursal, productos: [] };
      }
      grouped[key].productos.push(`${p.producto} x${p.cantidad}`);
    });

    Object.values(grouped).forEach(pedido => {
      const productosText = pedido.productos.join(", ");
      const item = document.createElement("div");
      item.className = "pedido";
      item.innerHTML = `
        <div><strong>Sucursal: ${pedido.sucursal || ''}</strong></div>
        <div class="muted">Productos: ${productosText}</div>
      `;
      modalPedBody.appendChild(item);
    });
  }
  modalPed.classList.add("show");
}



    // Cerrar modales al click fuera
    window.addEventListener("click", (ev) => {
      if (ev.target === modalCaf) modalCaf.classList.remove("show");
      if (ev.target === modalPed) modalPed.classList.remove("show");
    });

    // --- Navegación semanal: prev/next mueven baseDate por 7 días ---
    document.getElementById("prev").onclick = () => {
      baseDate = addDays(baseDate, -7);
      // si baseDate cae domingo, ajusta al día anterior (evitar iniciar en domingo)
      if (baseDate.getDay() === 0) baseDate = addDays(baseDate, -1);
      renderEightCards();
    };
    document.getElementById("next").onclick = () => {
      baseDate = addDays(baseDate, 7);
      if (baseDate.getDay() === 0) baseDate = addDays(baseDate, 1);
      renderEightCards();
    };
    document.getElementById("today").onclick = () => {
      baseDate = resetToLocalMidnight(new Date());
      if (baseDate.getDay() === 0) baseDate = addDays(baseDate, 1);
      renderEightCards();
    };

    // --- Realtime: escuchar INSERT/UPDATE/DELETE y recargar cache + render ---
    function setupRealtime() {
      client
        .channel('realtime-pedidos-8days')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'pedidos' }, () => {
          loadPedidos().then(renderEightCards);
        })
        .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'pedidos' }, () => {
          loadPedidos().then(renderEightCards);
        })
        .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'pedidos' }, () => {
          loadPedidos().then(renderEightCards);
        })
        .subscribe();
    }

    // --- Inicialización ---
    (async function init() {
      await loadPedidos();
      renderEightCards();
      setupRealtime();
    })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard de Pedidos</title>
  <style>
    body { font-family: sans-serif; background: #f5f5f5; }
    .tarjeta-dia {
      background: white;
      margin: 1rem;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      min-height: 100px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .tarjeta-dia.verde { background: #d4edda; }
    .tarjeta-dia h3 { margin-top: 0; color: #333; }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
    }
    .modal-content {
      background: white;
      margin: 5% auto;
      padding: 1rem;
      border-radius: 8px;
      width: 80%;
      max-width: 700px;
    }
    .modal-content.green { background: #d4edda; }
    .close { float: right; font-size: 1.5rem; cursor: pointer; }

    .cafeteria-card {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 0.5rem;
      margin: 0.5rem 0;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Pedidos próximos 6 días</h1>
  <div id="contenedor-dias"></div>

  <!-- Modal de cafeterías -->
  <div id="modal-cafeterias" class="modal">
    <div id="modal-cafeterias-content" class="modal-content">
      <span class="close" id="close-cafeterias">&times;</span>
      <h2 id="modal-cafeterias-title"></h2>
      <div id="modal-cafeterias-body"></div>
    </div>
  </div>

  <!-- Modal de pedidos por cafetería -->
  <div id="modal-pedidos" class="modal">
    <div id="modal-pedidos-content" class="modal-content">
      <span class="close" id="close-pedidos">&times;</span>
      <h2 id="modal-pedidos-title"></h2>
      <div id="modal-pedidos-body"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://pqphzdodpassomggthid.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxcGh6ZG9kcGFzc29tZ2d0aGlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1ODMxMTIsImV4cCI6MjA4MzE1OTExMn0.mQNeavAOItO-wTgfGVac-z91baYxsa6866HpBOZy3nM";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const contenedor = document.getElementById("contenedor-dias");

    async function cargarPedidos() {
      const { data: pedidos, error } = await client
        .from("pedidos")
        .select("id,cafeterias_id,sucursal,producto,cantidad,fecha_pedido,fecha_registro,notas,cafeterias(nombre)")
        .order("fecha_pedido",{ascending:true});

      if (error) { console.error(error); return; }

      // Calcular hoy y los próximos 5 días
      const hoy = new Date();
      const diasMostrar = [];
      for (let i=0; i<6; i++) {
        const fecha = new Date(hoy);
        fecha.setDate(hoy.getDate()+i);
        if (fecha.getDay() !== 0) { // excluir domingo
          diasMostrar.push(fecha);
        }
      }

      contenedor.innerHTML = "";
      diasMostrar.forEach(fecha => {
        const fechaStr = fecha.toLocaleDateString('es-MX',{weekday:'long',day:'numeric',month:'long'});
        const tarjeta = document.createElement("div");
        tarjeta.classList.add("tarjeta-dia");
        tarjeta.innerHTML = `<h3>${fechaStr}</h3>`;

        // filtrar pedidos de ese día
        const pedidosDia = pedidos.filter(p => {
          const f = new Date(p.fecha_pedido);
          return f.toDateString() === fecha.toDateString();
        });

        if (pedidosDia.length > 0) tarjeta.classList.add("verde");

        tarjeta.onclick = () => abrirModalCafeterias(fechaStr, pedidosDia);
        contenedor.appendChild(tarjeta);
      });
    }

    // Modal cafeterías
    const modalCafeterias = document.getElementById("modal-cafeterias");
    const modalCafeteriasTitle = document.getElementById("modal-cafeterias-title");
    const modalCafeteriasBody = document.getElementById("modal-cafeterias-body");
    document.getElementById("close-cafeterias").onclick = () => modalCafeterias.style.display="none";

    function abrirModalCafeterias(fechaStr, pedidosDia) {
      modalCafeteriasTitle.textContent = `Cafeterías con pedidos para ${fechaStr}`;
      modalCafeteriasBody.innerHTML = "";
      if (pedidosDia.length === 0) {
        modalCafeteriasBody.innerHTML = "<p>No hay pedidos.</p>";
      } else {
        const cafeteriasUnicas = [...new Set(pedidosDia.map(p=>p.cafeterias?.nombre))];
        cafeteriasUnicas.forEach(nombre => {
          const card = document.createElement("div");
          card.classList.add("cafeteria-card");
          card.textContent = nombre;
          card.onclick = () => abrirModalPedidos(nombre, pedidosDia.filter(p=>p.cafeterias?.nombre===nombre));
          modalCafeteriasBody.appendChild(card);
        });
      }
      modalCafeterias.style.display="block";
    }

    // Modal pedidos por cafetería
    const modalPedidos = document.getElementById("modal-pedidos");
    const modalPedidosTitle = document.getElementById("modal-pedidos-title");
    const modalPedidosBody = document.getElementById("modal-pedidos-body");
    document.getElementById("close-pedidos").onclick = () => modalPedidos.style.display="none";

    function abrirModalPedidos(nombre, pedidosCafe) {
      modalPedidosTitle.textContent = `Pedidos de ${nombre}`;
      modalPedidosBody.innerHTML = "";
      pedidosCafe.forEach(p => {
        const fechaRegistro = new Date(p.fecha_registro).toLocaleDateString('es-MX',{day:'numeric',month:'long',year:'numeric'});
        const item = document.createElement("div");
        item.classList.add("pedido");
        item.textContent = `${p.producto} x${p.cantidad} (registrado el ${fechaRegistro})`;
        modalPedidosBody.appendChild(item);
      });
      modalPedidos.style.display="block";
    }

    window.onclick = (event) => {
      if (event.target==modalCafeterias) modalCafeterias.style.display="none";
      if (event.target==modalPedidos) modalPedidos.style.display="none";
    };

    cargarPedidos();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Breck — Pedidos</title>
<style>
:root{ --bg:#f5f5f5; --card:#fff; --accent:#2c3e50; --ok:#27ae60; --muted:#666; }
body{ font-family:Arial, sans-serif; margin:0; padding:16px; background:var(--bg); color:#222; }
h1{ color:var(--accent); margin:0 0 12px; font-size:20px; text-align:center; }
.container{ max-width:980px; margin:0 auto; }
.card{ background:var(--card); border-radius:10px; padding:12px; margin-bottom:12px; border:1px solid #eaeaea; }
.product-row{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:8px; }
.product-row span{ flex:1; font-size:15px; }
.suc-inputs{ display:flex; gap:8px; }
.suc-col{ display:flex; flex-direction:column; min-width:84px; }
.suc-col label{ font-size:12px; color:var(--muted); margin-bottom:4px; }
input[type="number"], input[type="date"], textarea{ padding:8px; border-radius:8px; border:1px solid #ccc; font-size:15px; }
input[type="number"]{ width:72px; text-align:right; }
textarea{ width:100%; min-height:64px; resize:vertical; }
#enviar{ width:100%; padding:12px; border-radius:10px; border:none; background:var(--ok); color:#fff; font-size:16px; cursor:pointer; margin-top:8px; }
#status{ margin-top:8px; font-size:14px; text-align:center; }
.historial-item{ background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; margin-bottom:8px; }
.historial-item strong{ display:block; margin-bottom:4px; color:var(--accent); }
.historial-item ul{ margin:4px 0 0 16px; padding:0; }
.historial-item li{ font-size:14px; margin-bottom:2px; }
</style>
</head>
<body>
<div class="container">
  <h1>Breck — Formulario de pedidos</h1>
  <div class="card">
    <label for="fecha_pedido">Fecha de entrega</label>
    <input id="fecha_pedido" type="date" />
    <div id="productos"></div>
    <label for="notas">Notas (opcional)</label>
    <textarea id="notas"></textarea>
    <button id="enviar">Enviar Pedido</button>
    <div id="status"></div>
  </div>

  <h2>Historial de pedidos</h2>
  <div id="historial"></div>
</div>

<script>
const SUPABASE_URL = "https://pqphzdodpassomggthid.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxcGh6ZG9kcGFzc29tZ2d0aGlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1ODMxMTIsImV4cCI6MjA4MzE1OTExMn0.mQNeavAOItO-wTgfGVac-z91baYxsa6866HpBOZy3nM";
const TABLE_NAME = "pedidos";
const CAFETERIAS_ID = 1; // id real de Breck en tu tabla cafeterias

const PRODUCTOS = ["Croissant","Chocolatín","Hogaza","Foccacia","Brioche","Croissant Almendra","Chocolatín Almendra","Galleta Chispas","Galleta Avena","Galleta Red Velvet"];
const SUCURSALES = ["Bistro","Cafe"];

const productosDiv = document.getElementById("productos");
PRODUCTOS.forEach(prod=>{
  const row=document.createElement("div");
  row.className="product-row";
  const span=document.createElement("span");
  span.textContent=prod;
  const sucInputs=document.createElement("div");
  sucInputs.className="suc-inputs";
  SUCURSALES.forEach(suc=>{
    const wrap=document.createElement("div");
    wrap.className="suc-col";
    const label=document.createElement("label");
    label.textContent=suc;
    const inp=document.createElement("input");
    inp.type="number"; inp.min=0; inp.dataset.producto=prod; inp.dataset.sucursal=suc;
    wrap.appendChild(label); wrap.appendChild(inp);
    sucInputs.appendChild(wrap);
  });
  row.appendChild(span); row.appendChild(sucInputs);
  productosDiv.appendChild(row);
});

document.getElementById("enviar").onclick=async()=>{
  const fecha=document.getElementById("fecha_pedido").value;
  const notas=document.getElementById("notas").value||null;
  const registros=[];
  document.querySelectorAll("input[type=number]").forEach(inp=>{
    const cantidad=Number(inp.value||0);
    if(cantidad>0){
      registros.push({
        cafeterias_id:CAFETERIAS_ID,
        sucursal:inp.dataset.sucursal,
        producto:inp.dataset.producto,
        cantidad:cantidad,
        fecha_pedido:fecha,
        notas:notas
      });
    }
  });
  if(registros.length===0){alert("No hay cantidades");return;}
  document.getElementById("status").textContent="Enviando...";
  
  const res=await fetch(`${SUPABASE_URL}/rest/v1/${TABLE_NAME}`,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "apikey":SUPABASE_KEY,
      "Authorization":`Bearer ${SUPABASE_KEY}`,
      "Prefer":"return=minimal"
    },
    body:JSON.stringify(registros)
  });
  if(res.ok){
    document.getElementById("status").textContent="Pedido enviado correctamente.";
    document.querySelectorAll("input[type=number]").forEach(i=>i.value="");
    document.getElementById("notas").value="";
    cargarHistorial(); // refrescar historial
  }else{
    document.getElementById("status").textContent="Error: "+await res.text();
  }
};

// Historial
async function cargarHistorial() {
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE_NAME}?select=*`, {
      headers:{
        "apikey":SUPABASE_KEY,
        "Authorization":`Bearer ${SUPABASE_KEY}`
      }
    });
    const data = await res.json();
    const pedidosCafe = data.filter(p => p.cafeterias_id === CAFETERIAS_ID);
    const cont = document.getElementById("historial");
    cont.innerHTML = "";
    if(pedidosCafe.length===0){
      cont.textContent="No hay pedidos registrados.";
      return;
    }
    pedidosCafe.forEach(p=>{
      const div=document.createElement("div");
      div.className="historial-item";
      const fecha=p.fecha_pedido || "";
      div.innerHTML=`<strong>${fecha}</strong>Sucursal: ${p.sucursal||""}`;
      const ul=document.createElement("ul");
      ul.appendChild(document.createElement("li")).textContent=`${p.producto} x${p.cantidad}`;
      div.appendChild(ul);
      if(p.notas){ 
        const notas=document.createElement("div");
        notas.textContent="Notas: "+p.notas;
        div.appendChild(notas);
      }
      cont.appendChild(div);
    });
  } catch(err){
    console.error("Error cargando historial:",err);
  }
}
cargarHistorial();
</script>
</body>
</html>

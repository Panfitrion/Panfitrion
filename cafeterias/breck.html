<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Breck — Pedidos</title>
<style>
:root{ --bg:#f5f5f5; --card:#fff; --accent:#2c3e50; --ok:#27ae60; --muted:#666; }
*{box-sizing:border-box}
body{ font-family:Arial, sans-serif; margin:0; padding:16px; background:var(--bg); color:#222; }
h1{ color:var(--accent); margin:0 0 12px; font-size:20px; text-align:center; }

.container{ max-width:980px; margin:0 auto; }
.card{ background:var(--card); border-radius:10px; padding:12px; margin-bottom:12px; border:1px solid #eaeaea; box-shadow:0 6px 18px rgba(0,0,0,0.04); }
.header{ font-weight:700; background:var(--accent); color:#fff; padding:10px; border-radius:8px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }

.product-row{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:8px; }
.product-row span{ flex:1; font-size:15px; }

.suc-inputs{ display:flex; gap:8px; align-items:center; }
.suc-col{ display:flex; flex-direction:column; align-items:flex-end; min-width:84px; }
.suc-col label{ font-size:12px; color:var(--muted); margin-bottom:4px; }

input[type="number"], input[type="date"], select, textarea{ padding:8px; border-radius:8px; border:1px solid #ccc; font-size:15px; }
input[type="number"]{ width:72px; text-align:right; }
textarea{ width:100%; min-height:64px; resize:vertical; }

#enviar{ width:100%; padding:12px; border-radius:10px; border:none; background:var(--ok); color:#fff; font-size:16px; cursor:pointer; margin-top:8px; }
#status{ margin-top:8px; font-size:14px; text-align:center; color:#333; }

.day-list{ display:block; overflow:hidden; }

@media (max-width:720px){
  .product-row{ flex-direction:column; align-items:flex-start; gap:8px; }
  .suc-inputs{ width:100%; justify-content:flex-start; gap:10px; }
  .suc-col{ align-items:flex-start; min-width:0; }
  input[type="number"]{ width:100%; max-width:160px; text-align:left; }
}
</style>
</head>
<body>
<div class="container">
  <h1>Breck — Formulario de pedidos</h1>

  <div class="card">
    <div class="header">Pedido semanal</div>

    <div style="margin-bottom:10px;">
      <label for="fecha_pedido" style="font-size:14px;color:var(--muted);display:block;margin-bottom:6px;">Fecha de entrega</label>
      <input id="fecha_pedido" type="date" />
    </div>

    <div id="dias-container" class="day-list">
      <!-- Productos generados por JS -->
    </div>

    <div style="margin-top:10px;">
      <label for="notas" style="font-size:14px;color:var(--muted);display:block;margin-bottom:6px;">Notas (opcional)</label>
      <textarea id="notas" placeholder="Instrucciones o comentarios"></textarea>
    </div>

    <button id="enviar">Enviar Pedido</button>
    <div id="status" aria-live="polite"></div>

    <div style="margin-top:8px;font-size:13px;color:var(--muted)">Sucursales: <strong>Bistro</strong> y <strong>Cafe</strong></div>
  </div>
</div>

<script>
/* CONFIG: ajustar CAFETERIAS_ID si hace falta */
const SUPABASE_URL = "https://bytzcqefannnmbplypin.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5dHpjcWVmYW5ubm1icGx5cGluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MjAxNzIsImV4cCI6MjA4MDA5NjE3Mn0.rUvBeh-1LPos8h8FJksC_Ep9ofR5CZMKAgWdMGTHpvk";
const TABLE_NAME = "pedidos";
const CAFETERIAS_ID = 3; // cambia al id correspondiente en tu tabla cafeterias

const PRODUCTOS = ["Croissant","Chocolatín","Hogaza","Foccacia","Brioche","Croissant Almendra","Chocolatín Almendra","Galleta Chispas","Galleta Avena","Galleta Red Velvet"];
const SUCURSALES = ["Bistro","Cafe"];

const diasContainer = document.getElementById('dias-container');
const statusEl = document.getElementById('status');
const fechaInput = document.getElementById('fecha_pedido');
const notasInput = document.getElementById('notas');

/* Construir UI de productos */
(function buildUI(){
  PRODUCTOS.forEach(prod => {
    const row = document.createElement('div');
    row.className = 'product-row';

    const span = document.createElement('span');
    span.textContent = prod;

    const sucInputs = document.createElement('div');
    sucInputs.className = 'suc-inputs';

    SUCURSALES.forEach(suc => {
      const wrapper = document.createElement('div');
      wrapper.className = 'suc-col';

      const label = document.createElement('label');
      label.textContent = suc;

      const inp = document.createElement('input');
      inp.type = 'number';
      inp.min = 0;
      inp.value = '';
      inp.placeholder = '0';
      inp.dataset.producto = prod;
      inp.dataset.sucursal = suc;

      wrapper.appendChild(label);
      wrapper.appendChild(inp);
      sucInputs.appendChild(wrapper);
    });

    row.appendChild(span);
    row.appendChild(sucInputs);
    diasContainer.appendChild(row);
  });
})();

/* Enviar a Supabase */
document.getElementById('enviar').onclick = async () => {
  statusEl.textContent = '';
  const fecha_pedido = fechaInput.value;
  if(!fecha_pedido){
    alert("Selecciona la fecha de entrega.");
    return;
  }

  const notas = (notasInput.value || '').trim() || null;
  const registros = [];

  document.querySelectorAll('input[type="number"]').forEach(inp => {
    const raw = (inp.value ?? '').toString().trim();
    const cantidad = raw === '' ? 0 : Number(raw);
    if (cantidad <= 0) return;

    registros.push({
      cafeterias_id: CAFETERIAS_ID,
      sucursal: inp.dataset.sucursal,
      producto: inp.dataset.producto,
      cantidad: cantidad,
      fecha_pedido: fecha_pedido,
      notas: notas
    });
  });

  if(registros.length === 0){
    alert("No hay cantidades para enviar.");
    return;
  }

  try {
    statusEl.textContent = "Enviando pedido...";
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE_NAME}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "apikey": SUPABASE_KEY,
        "Authorization": `Bearer ${SUPABASE_KEY}`,
        "Prefer": "return=minimal"
      },
      body: JSON.stringify(registros)
    });

    if(res.ok){
      statusEl.textContent = "Pedido enviado correctamente.";
      document.querySelectorAll('input[type="number"]').forEach(i => i.value = '');
      notasInput.value = '';
    } else {
      const text = await res.text();
      statusEl.textContent = "Error al enviar pedido: " + text;
      console.error(text);
    }
  } catch (err) {
    statusEl.textContent = "Error de conexión: " + err;
    console.error(err);
  }
};
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Zuzu — Pedidos</title>
<style>
:root{ --bg:#f5f5f5; --card:#fff; --accent:#2c3e50; --ok:#27ae60; --muted:#666; }
body{ font-family:Arial, sans-serif; margin:0; padding:16px; background:var(--bg); color:#222; }
h1{ color:var(--accent); margin:0 0 12px; font-size:20px; text-align:center; }
.container{ max-width:980px; margin:0 auto; }
/* Selector de fechas con tarjetas */
.fecha-selector {
  display: flex;
  gap: 10px;
  margin: 20px 0;
  overflow-x: auto;
  padding: 0 0 10px 0;
}

.fecha-card {
  flex-shrink: 0;
  padding: 12px 18px;
  border-radius: 10px;
  border: 2px solid #ddd;
  background: #fff;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: center;
  min-width: 100px;
}

.fecha-card:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
}

.fecha-card.selected {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
  font-weight: bold;
}

.fecha-card-dia {
  font-size: 12px;
  color: var(--muted);
  text-transform: uppercase;
  margin-bottom: 4px;
}

.fecha-card.selected .fecha-card-dia {
  color: rgba(255,255,255,0.8);
}

.fecha-card-num {
  font-size: 18px;
  font-weight: bold;
}
.card{ background:var(--card); border-radius:10px; padding:12px; margin-bottom:12px; border:1px solid #eaeaea; }
.product-row{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:8px; }
.product-row span{ flex:1; font-size:15px; }
.suc-inputs{ display:flex; gap:8px; }
.suc-col{ display:flex; flex-direction:column; min-width:84px; }
.suc-col label{ font-size:12px; color:var(--muted); margin-bottom:4px; }
input[type="number"], input[type="date"], textarea{ padding:8px; border-radius:8px; border:1px solid #ccc; font-size:15px; }
input[type="number"]{ width:72px; text-align:right; }
textarea{ width:100%; min-height:64px; resize:vertical; }
#enviar{ width:100%; padding:12px; border-radius:10px; border:none; background:var(--ok); color:#fff; font-size:16px; cursor:pointer; margin-top:8px; }
#status{ margin-top:8px; font-size:14px; text-align:center; }
.empty { color:var(--muted); padding:8px; background:#fff; border-radius:8px; border:1px dashed #e0e0e0; text-align:center; }
.historial-item{ background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; margin-bottom:8px; }
.historial-item strong{ display:block; margin-bottom:4px; color:var(--accent); }
.historial-item ul{ margin:4px 0 0 16px; padding:0; }
.historial-item li{ font-size:14px; margin-bottom:2px; }
.historial-meta{ color:var(--muted); font-size:13px; margin-bottom:6px; }
</style>
</head>
<body>
<div class="container">
  <h1>Zuzu — pedidos</h1>

  <div class="card">
    <label style="display:block; margin-bottom: 12px;">Selecciona la fecha de entrega:</label>
    <div id="fecha_selector" class="fecha-selector"></div>
    <input id="fecha_pedido" type="date" style="display: none;" />
    <div id="productos" style="margin-top:12px;"></div>
    <label for="notas" style="margin-top:8px; display:block;">Notas (opcional)</label>
    <textarea id="notas"></textarea>
    <button id="enviar">Enviar Pedido</button>
    <div id="status"></div>
  </div>

  <h2>Consultar pedidos por fecha</h2>
  <div class="card">
    <div style="display:flex; gap:8px; align-items:center;">
      <input id="fecha_historial" type="date" style="flex:1;" />
      <button id="ver_pedidos" style="padding:8px 12px;">Ver pedidos</button>
    </div>
    <div id="historial" style="margin-top:12px;"></div>
  </div>
</div>

<script>
/* CONFIGURACIÓN: editar según tu proyecto */
const SUPABASE_URL = "https://pqphzdodpassomggthid.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxcGh6ZG9kcGFzc29tZ2d0aGlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1ODMxMTIsImV4cCI6MjA4MzE1OTExMn0.mQNeavAOItO-wTgfGVac-z91baYxsa6866HpBOZy3nM"; // reemplaza con tu API key
const TABLE_NAME = "pedidos";

/* Datos de esta cafetería */
const CAFETERIA = "Zuzu";
const CAFETERIAS_ID = 4; // reemplaza con el id real en tu tabla cafeterias
const PRODUCTOS = [
  "Chocolatín","Croissant Almendra","Croissant Frutal","Scone","Muffin","Rol de Canela"
];
const SUCURSALES = ["Principal"]; // si hay más sucursales, agrégalas aquí

/* -------------------------
   Utilidades de fecha
   ------------------------- */
function resetToLocalMidnight(d) {
  return new Date(d.getFullYear(), d.getMonth(), d.getDate());
}

function addDays(d, n) {
  const x = new Date(d);
  x.setDate(x.getDate() + n);
  return resetToLocalMidnight(x);
}

function toDateString(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const da = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${da}`;
}

/* -------------------------
   Inicializar selector de fechas
   ------------------------- */
function initFechaSelector() {
  const selector = document.getElementById("fecha_selector");
  const today = resetToLocalMidnight(new Date());
  
  selector.innerHTML = "";
  
  // Mostrar 5 días a partir de hoy
  for (let i = 0; i < 5; i++) {
    const fecha = addDays(today, i);
    const diaSemana = fecha.toLocaleDateString('es-MX', { weekday: 'short' });
    const dia = fecha.getDate();
    
    const card = document.createElement("div");
    card.className = "fecha-card";
    card.dataset.fecha = toDateString(fecha);
    card.innerHTML = `
      <div class="fecha-card-dia">${diaSemana}</div>
      <div class="fecha-card-num">${dia}</div>
    `;
    
    card.onclick = () => selectFecha(card);
    selector.appendChild(card);
  }
  
  // Seleccionar el primer día por defecto
  const firstCard = selector.querySelector(".fecha-card");
  if (firstCard) {
    selectFecha(firstCard);
  }
}

function selectFecha(card) {
  // Desseleccionar todas
  document.querySelectorAll(".fecha-card").forEach(c => c.classList.remove("selected"));
  
  // Seleccionar la clickeada
  card.classList.add("selected");
  
  // Actualizar el input hidden
  document.getElementById("fecha_pedido").value = card.dataset.fecha;
}

/* Construir formulario (inputs vacíos) */
const productosDiv = document.getElementById("productos");
PRODUCTOS.forEach(prod=>{
  const row = document.createElement("div");
  row.className = "product-row";

  const span = document.createElement("span");
  span.textContent = prod;

  const sucInputs = document.createElement("div");
  sucInputs.className = "suc-inputs";

  SUCURSALES.forEach(suc=>{
    const wrap = document.createElement("div");
    wrap.className = "suc-col";

    const label = document.createElement("label");
    label.textContent = suc;

    const inp = document.createElement("input");
    inp.type = "number";
    inp.min = 0;
    // inputs empiezan vacíos
    inp.dataset.producto = prod;
    inp.dataset.sucursal = suc;

    wrap.appendChild(label);
    wrap.appendChild(inp);
    sucInputs.appendChild(wrap);
  });

  row.appendChild(span);
  row.appendChild(sucInputs);
  productosDiv.appendChild(row);
});

/* Envío con validación por sucursal (evita duplicados por sucursal+fecha) */
document.getElementById("enviar").onclick = async () => {
  const fecha = document.getElementById("fecha_pedido").value;
  if (!fecha) { alert("Selecciona la fecha de entrega."); return; }

  const notas = document.getElementById("notas").value || null;
  const registros = [];

  document.querySelectorAll("input[type=number]").forEach(inp=>{
    const cantidad = Number(inp.value || 0);
    if (cantidad > 0) {
      registros.push({
        cafeterias_id: CAFETERIAS_ID,
        sucursal: inp.dataset.sucursal,
        producto: inp.dataset.producto,
        cantidad: cantidad,
        fecha_pedido: fecha,
        notas: notas
      });
    }
  });

  if (registros.length === 0) { alert("No hay cantidades para enviar."); return; }

  // Validar duplicados por sucursal: consultar si ya existe pedido para la misma sucursal y fecha
  const sucursalesAConsultar = Array.from(new Set(registros.map(r => r.sucursal)));
  for (const suc of sucursalesAConsultar) {
    const checkRes = await fetch(
      `${SUPABASE_URL}/rest/v1/${TABLE_NAME}?select=id&cafeterias_id=eq.${CAFETERIAS_ID}&sucursal=eq.${encodeURIComponent(suc)}&fecha_pedido=eq.${fecha}`,
      {
        headers: {
          "apikey": SUPABASE_KEY,
          "Authorization": `Bearer ${SUPABASE_KEY}`
        }
      }
    );
    if (!checkRes.ok) {
      alert("Error al validar duplicados. Intenta de nuevo.");
      return;
    }
    const existing = await checkRes.json();
    if (existing.length > 0) {
      alert(`Ya existe un pedido para la sucursal "${suc}" en la fecha seleccionada. No se enviará el pedido duplicado.`);
      return;
    }
  }

  document.getElementById("status").textContent = "Enviando...";
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE_NAME}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "apikey": SUPABASE_KEY,
        "Authorization": `Bearer ${SUPABASE_KEY}`,
        "Prefer": "return=minimal"
      },
      body: JSON.stringify(registros)
    });

    if (res.ok) {
      document.getElementById("status").textContent = "Pedido enviado correctamente.";
      document.querySelectorAll("input[type=number]").forEach(i => i.value = "");
      document.getElementById("notas").value = "";
      // refrescar historial si hay fecha seleccionada
      const fechaHist = document.getElementById("fecha_historial").value;
      if (fechaHist === fecha) cargarHistorial();
    } else {
      const text = await res.text();
      document.getElementById("status").textContent = "Error: " + text;
    }
  } catch (err) {
    document.getElementById("status").textContent = "Error de conexión: " + err;
  }
};

/* Historial por fecha (muestra pedidos agrupados por sucursal) */
document.getElementById("ver_pedidos").onclick = cargarHistorial;
async function cargarHistorial(){
  const fecha = document.getElementById("fecha_historial").value;
  const cont = document.getElementById("historial");
  if(!fecha){ alert("Selecciona una fecha."); return; }

  cont.innerHTML = '<div class="empty">Cargando pedidos...</div>';
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE_NAME}?select=*`, {
      headers: { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}` }
    });
    if (!res.ok) {
      cont.innerHTML = '<div class="empty">No se pudo cargar el historial.</div>';
      return;
    }
    const data = await res.json();

    // Filtrar por cafetería + fecha
    const pedidos = data.filter(p => Number(p.cafeterias_id) === Number(CAFETERIAS_ID) && p.fecha_pedido === fecha);
    if (pedidos.length === 0) {
      cont.innerHTML = '<div class="empty">No hay pedidos para esa fecha.</div>';
      return;
    }

    // Agrupar por sucursal y sumar cantidades por producto
    const grouped = {};
    pedidos.forEach(p => {
      const suc = p.sucursal || "—";
      if (!grouped[suc]) grouped[suc] = { productos: {}, notas: [] };
      grouped[suc].productos[p.producto] = (grouped[suc].productos[p.producto] || 0) + Number(p.cantidad || 0);
      if (p.notas) grouped[suc].notas.push(p.notas);
    });

    cont.innerHTML = "";
    Object.entries(grouped).forEach(([suc, block]) => {
      const div = document.createElement("div");
      div.className = "historial-item";

      const meta = document.createElement("div");
      meta.className = "historial-meta";
      meta.textContent = `${fecha} — Sucursal: ${suc}`;
      div.appendChild(meta);

      const ul = document.createElement("ul");
      Object.keys(block.productos).forEach(prodName => {
        const li = document.createElement("li");
        li.textContent = `${prodName} x${block.productos[prodName]}`;
        ul.appendChild(li);
      });
      div.appendChild(ul);

      if (block.notas.length > 0) {
        const notasDiv = document.createElement("div");
        notasDiv.style.marginTop = "6px";
        notasDiv.style.fontSize = "13px";
        notasDiv.style.color = "var(--muted)";
        notasDiv.textContent = "Notas: " + Array.from(new Set(block.notas)).join(" | ");
        div.appendChild(notasDiv);
      }

      cont.appendChild(div);
    });

  } catch (err) {
    console.error("Error cargando historial:", err);
    cont.innerHTML = '<div class="empty">Error cargando historial.</div>';
  }
}

/* Inicializar al cargar */
initFechaSelector();
</script>
</body>
</html>
